<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Real-time Network Monitor</title>
    <style>
        :root {
            --bg-color: #0d1117;
            --text-color: #c9d1d9;
            --accent-color: #58a6ff;
            --border-color: #30363d;
            --success-color: #2ea043;
            --warning-color: #d29922;
        }

        body {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--accent-color);
        }

        .controls button {
            background-color: var(--border-color);
            color: var(--text-color);
            border: 1px solid var(--text-color);
            padding: 8px 16px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .controls button:hover {
            background-color: var(--accent-color);
            color: var(--bg-color);
        }

        .controls button.active {
            background-color: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .status-bar {
            margin-bottom: 15px;
            font-size: 0.9rem;
            color: #8b949e;
        }

        /* Table Styling */
        .table-container {
            overflow-x: auto;
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th, td {
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #161b22;
            color: var(--accent-color);
            position: sticky;
            top: 0;
        }

        tr:hover {
            background-color: #161b22;
        }

        /* Status Colors */
        .status-established { color: var(--success-color); font-weight: bold; }
        .status-listen { color: var(--warning-color); }
        .status-close-wait { color: #f85149; }
        
        .protocol-tcp { color: #79c0ff; }
        .protocol-udp { color: #d2a8ff; }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-color); }
        ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    </style>
</head>
<body>

    <div class="container">
        <header>
            <h1>>_ SYSTEM NETWORK MONITOR</h1>
            <div class="controls">
                <button id="btnToggle" onclick="toggleMonitoring()">Start Monitoring</button>
            </div>
        </header>

        <div class="status-bar">
            Local Host: 127.0.0.1 | Status: <span id="monitorStatus">STOPPED</span> | Total Connections: <span id="connCount">0</span>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>TIME</th>
                        <th>PROCESS (PID)</th>
                        <th>PROTO</th>
                        <th>LOCAL ADDRESS</th>
                        <th>REMOTE ADDRESS</th>
                        <th>STATE</th>
                    </tr>
                </thead>
                <tbody id="logBody">
                    <tr><td colspan="6" style="text-align:center">Press Start to begin monitoring...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let isRunning = false;
        let intervalId = null;
        const btnToggle = document.getElementById('btnToggle');
        const statusLabel = document.getElementById('monitorStatus');
        const connCountLabel = document.getElementById('connCount');
        const tbody = document.getElementById('logBody');

        function toggleMonitoring() {
            if (isRunning) {
                stopMonitoring();
            } else {
                startMonitoring();
            }
        }

        function startMonitoring() {
            isRunning = true;
            btnToggle.innerText = "Stop Monitoring";
            btnToggle.classList.add('active');
            statusLabel.innerText = "RUNNING (Polling 2s)";
            statusLabel.style.color = "#2ea043";
            
            // Fetch immediately then interval
            fetchData();
            intervalId = setInterval(fetchData, 2000);
        }

        function stopMonitoring() {
            isRunning = false;
            btnToggle.innerText = "Start Monitoring";
            btnToggle.classList.remove('active');
            statusLabel.innerText = "STOPPED";
            statusLabel.style.color = "#8b949e";
            clearInterval(intervalId);
        }

        async function fetchData() {
            try {
                const response = await fetch('/api/activity');
                const data = await response.json();
                renderTable(data);
            } catch (error) {
                console.error("Error fetching data:", error);
                statusLabel.innerText = "ERROR CONNECTION";
                statusLabel.style.color = "red";
            }
        }

        function renderTable(data) {
            connCountLabel.innerText = data.length;
            tbody.innerHTML = ''; // Clear old data

            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">No active connections found.</td></tr>';
                return;
            }

            data.forEach(item => {
                const tr = document.createElement('tr');
                
                // Color coding for status
                let statusClass = '';
                if (item.status === 'ESTABLISHED') statusClass = 'status-established';
                else if (item.status === 'LISTEN') statusClass = 'status-listen';
                else if (item.status === 'CLOSE_WAIT') statusClass = 'status-close-wait';

                // Color coding for protocol
                let protoClass = item.protocol === 'TCP' ? 'protocol-tcp' : 'protocol-udp';

                tr.innerHTML = `
                    <td>${item.time}</td>
                    <td><strong>${item.process_name}</strong> <span style="font-size:0.8em; opacity:0.7">(${item.pid})</span></td>
                    <td class="${protoClass}">${item.protocol}</td>
                    <td>${item.laddr}</td>
                    <td>${item.raddr}</td>
                    <td class="${statusClass}">${item.status}</td>
                `;
                tbody.appendChild(tr);
            });
        }
    </script>
</body>
</html>